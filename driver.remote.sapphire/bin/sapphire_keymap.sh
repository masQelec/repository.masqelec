#!/storage/.kodi/addons/driver.remote.sapphire/bin/bash
#
# sapphire_keymap.sh   by Mark Lord <mlord@pobox.com>, April/2013.
# http://rtr.ca/sapphire_remote/
#
# Script to translate a symbolic keymap file for the Sapphire driver
# into hex format and feed the results to /proc/sapphire.
#
# This can be invoked on the fly, as often as desired.
# Eg. to change keymaps to match a specific program, such as mythfrontend or xbmc.
# 
# By default, this script reads key mappings from /etc/sapphire.keymap
# but this can be overridden by supplying an alternative path/file as a parameter.
#
# Eg.      sapphire_keymap.sh ~/.sapphire_keymap
#

## Arrays for Buttons, Keycodes, and Modifiers:
##'
declare -A K B M

## keycodes extracted from /var/corebuild/CoreELEC/build.CoreELEC-Amlogic.arm-9.2-devel/toolchain/armv8a-libreelec-linux-gnueabi/sysroot/usr/include/linux/input.h:
##
K[KEY_ESC]=0x00000001
K[KEY_1]=0x00000002
K[KEY_2]=0x00000003
K[KEY_3]=0x00000004
K[KEY_4]=0x00000005
K[KEY_5]=0x00000006
K[KEY_6]=0x00000007
K[KEY_7]=0x00000008
K[KEY_8]=0x00000009
K[KEY_9]=0x0000000a
K[KEY_0]=0x0000000b
K[KEY_MINUS]=0x0000000c
K[KEY_EQUAL]=0x0000000d
K[KEY_BACKSPACE]=0x0000000e
K[KEY_TAB]=0x0000000f
K[KEY_Q]=0x00000010
K[KEY_W]=0x00000011
K[KEY_E]=0x00000012
K[KEY_R]=0x00000013
K[KEY_T]=0x00000014
K[KEY_Y]=0x00000015
K[KEY_U]=0x00000016
K[KEY_I]=0x00000017
K[KEY_O]=0x00000018
K[KEY_P]=0x00000019
K[KEY_LEFTBRACE]=0x0000001a
K[KEY_RIGHTBRACE]=0x0000001b
K[KEY_ENTER]=0x0000001c
K[KEY_LEFTCTRL]=0x0000001d
K[KEY_A]=0x0000001e
K[KEY_S]=0x0000001f
K[KEY_D]=0x00000020
K[KEY_F]=0x00000021
K[KEY_G]=0x00000022
K[KEY_H]=0x00000023
K[KEY_J]=0x00000024
K[KEY_K]=0x00000025
K[KEY_L]=0x00000026
K[KEY_SEMICOLON]=0x00000027
K[KEY_APOSTROPHE]=0x00000028
K[KEY_GRAVE]=0x00000029
K[KEY_LEFTSHIFT]=0x0000002a
K[KEY_BACKSLASH]=0x0000002b
K[KEY_Z]=0x0000002c
K[KEY_X]=0x0000002d
K[KEY_C]=0x0000002e
K[KEY_V]=0x0000002f
K[KEY_B]=0x00000030
K[KEY_N]=0x00000031
K[KEY_M]=0x00000032
K[KEY_COMMA]=0x00000033
K[KEY_DOT]=0x00000034
K[KEY_SLASH]=0x00000035
K[KEY_RIGHTSHIFT]=0x00000036
K[KEY_KPASTERISK]=0x00000037
K[KEY_LEFTALT]=0x00000038
K[KEY_SPACE]=0x00000039
K[KEY_CAPSLOCK]=0x0000003a
K[KEY_F1]=0x0000003b
K[KEY_F2]=0x0000003c
K[KEY_F3]=0x0000003d
K[KEY_F4]=0x0000003e
K[KEY_F5]=0x0000003f
K[KEY_F6]=0x00000040
K[KEY_F7]=0x00000041
K[KEY_F8]=0x00000042
K[KEY_F9]=0x00000043
K[KEY_F10]=0x00000044
K[KEY_NUMLOCK]=0x00000045
K[KEY_SCROLLLOCK]=0x00000046
K[KEY_KP7]=0x00000047
K[KEY_KP8]=0x00000048
K[KEY_KP9]=0x00000049
K[KEY_KPMINUS]=0x0000004a
K[KEY_KP4]=0x0000004b
K[KEY_KP5]=0x0000004c
K[KEY_KP6]=0x0000004d
K[KEY_KPPLUS]=0x0000004e
K[KEY_KP1]=0x0000004f
K[KEY_KP2]=0x00000050
K[KEY_KP3]=0x00000051
K[KEY_KP0]=0x00000052
K[KEY_KPDOT]=0x00000053
K[KEY_ZENKAKUHANKAKU]=0x00000055
K[KEY_102ND]=0x00000056
K[KEY_F11]=0x00000057
K[KEY_F12]=0x00000058
K[KEY_RO]=0x00000059
K[KEY_KATAKANA]=0x0000005a
K[KEY_HIRAGANA]=0x0000005b
K[KEY_HENKAN]=0x0000005c
K[KEY_KATAKANAHIRAGANA]=0x0000005d
K[KEY_MUHENKAN]=0x0000005e
K[KEY_KPJPCOMMA]=0x0000005f
K[KEY_KPENTER]=0x00000060
K[KEY_RIGHTCTRL]=0x00000061
K[KEY_KPSLASH]=0x00000062
K[KEY_SYSRQ]=0x00000063
K[KEY_RIGHTALT]=0x00000064
K[KEY_LINEFEED]=0x00000065
K[KEY_HOME]=0x00000066
K[KEY_UP]=0x00000067
K[KEY_PAGEUP]=0x00000068
K[KEY_LEFT]=0x00000069
K[KEY_RIGHT]=0x0000006a
K[KEY_END]=0x0000006b
K[KEY_DOWN]=0x0000006c
K[KEY_PAGEDOWN]=0x0000006d
K[KEY_INSERT]=0x0000006e
K[KEY_DELETE]=0x0000006f
K[KEY_MACRO]=0x00000070
K[KEY_MUTE]=0x00000071
K[KEY_VOLUMEDOWN]=0x00000072
K[KEY_VOLUMEUP]=0x00000073
K[KEY_POWER]=0x00000074
K[KEY_KPEQUAL]=0x00000075
K[KEY_KPPLUSMINUS]=0x00000076
K[KEY_PAUSE]=0x00000077
K[KEY_SCALE]=0x00000078
K[KEY_KPCOMMA]=0x00000079
K[KEY_HANGEUL]=0x0000007a
K[KEY_HANJA]=0x0000007b
K[KEY_YEN]=0x0000007c
K[KEY_LEFTMETA]=0x0000007d
K[KEY_RIGHTMETA]=0x0000007e
K[KEY_COMPOSE]=0x0000007f
K[KEY_STOP]=0x00000080
K[KEY_AGAIN]=0x00000081
K[KEY_PROPS]=0x00000082
K[KEY_UNDO]=0x00000083
K[KEY_FRONT]=0x00000084
K[KEY_COPY]=0x00000085
K[KEY_OPEN]=0x00000086
K[KEY_PASTE]=0x00000087
K[KEY_FIND]=0x00000088
K[KEY_CUT]=0x00000089
K[KEY_HELP]=0x0000008a
K[KEY_MENU]=0x0000008b
K[KEY_CALC]=0x0000008c
K[KEY_SETUP]=0x0000008d
K[KEY_SLEEP]=0x0000008e
K[KEY_WAKEUP]=0x0000008f
K[KEY_FILE]=0x00000090
K[KEY_SENDFILE]=0x00000091
K[KEY_DELETEFILE]=0x00000092
K[KEY_XFER]=0x00000093
K[KEY_PROG1]=0x00000094
K[KEY_PROG2]=0x00000095
K[KEY_WWW]=0x00000096
K[KEY_MSDOS]=0x00000097
K[KEY_COFFEE]=0x00000098
K[KEY_DIRECTION]=0x00000099
K[KEY_CYCLEWINDOWS]=0x0000009a
K[KEY_MAIL]=0x0000009b
K[KEY_BOOKMARKS]=0x0000009c
K[KEY_COMPUTER]=0x0000009d
K[KEY_BACK]=0x0000009e
K[KEY_FORWARD]=0x0000009f
K[KEY_CLOSECD]=0x000000a0
K[KEY_EJECTCD]=0x000000a1
K[KEY_EJECTCLOSECD]=0x000000a2
K[KEY_NEXTSONG]=0x000000a3
K[KEY_PLAYPAUSE]=0x000000a4
K[KEY_PREVIOUSSONG]=0x000000a5
K[KEY_STOPCD]=0x000000a6
K[KEY_RECORD]=0x000000a7
K[KEY_REWIND]=0x000000a8
K[KEY_PHONE]=0x000000a9
K[KEY_ISO]=0x000000aa
K[KEY_CONFIG]=0x000000ab
K[KEY_HOMEPAGE]=0x000000ac
K[KEY_REFRESH]=0x000000ad
K[KEY_EXIT]=0x000000ae
K[KEY_MOVE]=0x000000af
K[KEY_EDIT]=0x000000b0
K[KEY_SCROLLUP]=0x000000b1
K[KEY_SCROLLDOWN]=0x000000b2
K[KEY_KPLEFTPAREN]=0x000000b3
K[KEY_KPRIGHTPAREN]=0x000000b4
K[KEY_NEW]=0x000000b5
K[KEY_REDO]=0x000000b6
K[KEY_F13]=0x000000b7
K[KEY_F14]=0x000000b8
K[KEY_F15]=0x000000b9
K[KEY_F16]=0x000000ba
K[KEY_F17]=0x000000bb
K[KEY_F18]=0x000000bc
K[KEY_F19]=0x000000bd
K[KEY_F20]=0x000000be
K[KEY_F21]=0x000000bf
K[KEY_F22]=0x000000c0
K[KEY_F23]=0x000000c1
K[KEY_F24]=0x000000c2
K[KEY_PLAYCD]=0x000000c8
K[KEY_PAUSECD]=0x000000c9
K[KEY_PROG3]=0x000000ca
K[KEY_PROG4]=0x000000cb
K[KEY_DASHBOARD]=0x000000cc
K[KEY_SUSPEND]=0x000000cd
K[KEY_CLOSE]=0x000000ce
K[KEY_PLAY]=0x000000cf
K[KEY_FASTFORWARD]=0x000000d0
K[KEY_BASSBOOST]=0x000000d1
K[KEY_PRINT]=0x000000d2
K[KEY_HP]=0x000000d3
K[KEY_CAMERA]=0x000000d4
K[KEY_SOUND]=0x000000d5
K[KEY_QUESTION]=0x000000d6
K[KEY_EMAIL]=0x000000d7
K[KEY_CHAT]=0x000000d8
K[KEY_SEARCH]=0x000000d9
K[KEY_CONNECT]=0x000000da
K[KEY_FINANCE]=0x000000db
K[KEY_SPORT]=0x000000dc
K[KEY_SHOP]=0x000000dd
K[KEY_ALTERASE]=0x000000de
K[KEY_CANCEL]=0x000000df
K[KEY_BRIGHTNESSDOWN]=0x000000e0
K[KEY_BRIGHTNESSUP]=0x000000e1
K[KEY_MEDIA]=0x000000e2
K[KEY_SWITCHVIDEOMODE]=0x000000e3
K[KEY_KBDILLUMTOGGLE]=0x000000e4
K[KEY_KBDILLUMDOWN]=0x000000e5
K[KEY_KBDILLUMUP]=0x000000e6
K[KEY_SEND]=0x000000e7
K[KEY_REPLY]=0x000000e8
K[KEY_FORWARDMAIL]=0x000000e9
K[KEY_SAVE]=0x000000ea
K[KEY_DOCUMENTS]=0x000000eb
K[KEY_BATTERY]=0x000000ec
K[KEY_BLUETOOTH]=0x000000ed
K[KEY_WLAN]=0x000000ee
K[KEY_UWB]=0x000000ef
K[KEY_UNKNOWN]=0x000000f0
K[KEY_VIDEO_NEXT]=0x000000f1
K[KEY_VIDEO_PREV]=0x000000f2
K[KEY_BRIGHTNESS_CYCLE]=0x000000f3
K[KEY_BRIGHTNESS_AUTO]=0x000000f4
K[KEY_DISPLAY_OFF]=0x000000f5
K[KEY_WWAN]=0x000000f6
K[KEY_RFKILL]=0x000000f7
K[KEY_MICMUTE]=0x000000f8
K[KEY_OK]=0x00000160
K[KEY_SELECT]=0x00000161
K[KEY_GOTO]=0x00000162
K[KEY_CLEAR]=0x00000163
K[KEY_POWER2]=0x00000164
K[KEY_OPTION]=0x00000165
K[KEY_INFO]=0x00000166
K[KEY_TIME]=0x00000167
K[KEY_VENDOR]=0x00000168
K[KEY_ARCHIVE]=0x00000169
K[KEY_PROGRAM]=0x0000016a
K[KEY_CHANNEL]=0x0000016b
K[KEY_FAVORITES]=0x0000016c
K[KEY_EPG]=0x0000016d
K[KEY_PVR]=0x0000016e
K[KEY_MHP]=0x0000016f
K[KEY_LANGUAGE]=0x00000170
K[KEY_TITLE]=0x00000171
K[KEY_SUBTITLE]=0x00000172
K[KEY_ANGLE]=0x00000173
K[KEY_ZOOM]=0x00000174
K[KEY_MODE]=0x00000175
K[KEY_KEYBOARD]=0x00000176
K[KEY_SCREEN]=0x00000177
K[KEY_PC]=0x00000178
K[KEY_TV]=0x00000179
K[KEY_TV2]=0x0000017a
K[KEY_VCR]=0x0000017b
K[KEY_VCR2]=0x0000017c
K[KEY_SAT]=0x0000017d
K[KEY_SAT2]=0x0000017e
K[KEY_CD]=0x0000017f
K[KEY_TAPE]=0x00000180
K[KEY_RADIO]=0x00000181
K[KEY_TUNER]=0x00000182
K[KEY_PLAYER]=0x00000183
K[KEY_TEXT]=0x00000184
K[KEY_DVD]=0x00000185
K[KEY_AUX]=0x00000186
K[KEY_MP3]=0x00000187
K[KEY_AUDIO]=0x00000188
K[KEY_VIDEO]=0x00000189
K[KEY_DIRECTORY]=0x0000018a
K[KEY_LIST]=0x0000018b
K[KEY_MEMO]=0x0000018c
K[KEY_CALENDAR]=0x0000018d
K[KEY_RED]=0x0000018e
K[KEY_GREEN]=0x0000018f
K[KEY_YELLOW]=0x00000190
K[KEY_BLUE]=0x00000191
K[KEY_CHANNELUP]=0x00000192
K[KEY_CHANNELDOWN]=0x00000193
K[KEY_FIRST]=0x00000194
K[KEY_LAST]=0x00000195
K[KEY_AB]=0x00000196
K[KEY_NEXT]=0x00000197
K[KEY_RESTART]=0x00000198
K[KEY_SLOW]=0x00000199
K[KEY_SHUFFLE]=0x0000019a
K[KEY_BREAK]=0x0000019b
K[KEY_PREVIOUS]=0x0000019c
K[KEY_DIGITS]=0x0000019d
K[KEY_TEEN]=0x0000019e
K[KEY_TWEN]=0x0000019f
K[KEY_VIDEOPHONE]=0x000001a0
K[KEY_GAMES]=0x000001a1
K[KEY_ZOOMIN]=0x000001a2
K[KEY_ZOOMOUT]=0x000001a3
K[KEY_ZOOMRESET]=0x000001a4
K[KEY_WORDPROCESSOR]=0x000001a5
K[KEY_EDITOR]=0x000001a6
K[KEY_SPREADSHEET]=0x000001a7
K[KEY_GRAPHICSEDITOR]=0x000001a8
K[KEY_PRESENTATION]=0x000001a9
K[KEY_DATABASE]=0x000001aa
K[KEY_NEWS]=0x000001ab
K[KEY_VOICEMAIL]=0x000001ac
K[KEY_ADDRESSBOOK]=0x000001ad
K[KEY_MESSENGER]=0x000001ae
K[KEY_DISPLAYTOGGLE]=0x000001af
K[KEY_SPELLCHECK]=0x000001b0
K[KEY_LOGOFF]=0x000001b1
K[KEY_DOLLAR]=0x000001b2
K[KEY_EURO]=0x000001b3
K[KEY_FRAMEBACK]=0x000001b4
K[KEY_FRAMEFORWARD]=0x000001b5
K[KEY_CONTEXT_MENU]=0x000001b6
K[KEY_MEDIA_REPEAT]=0x000001b7
K[KEY_10CHANNELSUP]=0x000001b8
K[KEY_10CHANNELSDOWN]=0x000001b9
K[KEY_IMAGES]=0x000001ba
K[KEY_DEL_EOL]=0x000001c0
K[KEY_DEL_EOS]=0x000001c1
K[KEY_INS_LINE]=0x000001c2
K[KEY_DEL_LINE]=0x000001c3
K[KEY_FN]=0x000001d0
K[KEY_FN_ESC]=0x000001d1
K[KEY_FN_F1]=0x000001d2
K[KEY_FN_F2]=0x000001d3
K[KEY_FN_F3]=0x000001d4
K[KEY_FN_F4]=0x000001d5
K[KEY_FN_F5]=0x000001d6
K[KEY_FN_F6]=0x000001d7
K[KEY_FN_F7]=0x000001d8
K[KEY_FN_F8]=0x000001d9
K[KEY_FN_F9]=0x000001da
K[KEY_FN_F10]=0x000001db
K[KEY_FN_F11]=0x000001dc
K[KEY_FN_F12]=0x000001dd
K[KEY_FN_1]=0x000001de
K[KEY_FN_2]=0x000001df
K[KEY_FN_D]=0x000001e0
K[KEY_FN_E]=0x000001e1
K[KEY_FN_F]=0x000001e2
K[KEY_FN_S]=0x000001e3
K[KEY_FN_B]=0x000001e4
K[KEY_BRL_DOT1]=0x000001f1
K[KEY_BRL_DOT2]=0x000001f2
K[KEY_BRL_DOT3]=0x000001f3
K[KEY_BRL_DOT4]=0x000001f4
K[KEY_BRL_DOT5]=0x000001f5
K[KEY_BRL_DOT6]=0x000001f6
K[KEY_BRL_DOT7]=0x000001f7
K[KEY_BRL_DOT8]=0x000001f8
K[KEY_BRL_DOT9]=0x000001f9
K[KEY_BRL_DOT10]=0x000001fa
K[KEY_NUMERIC_0]=0x00000200
K[KEY_NUMERIC_1]=0x00000201
K[KEY_NUMERIC_2]=0x00000202
K[KEY_NUMERIC_3]=0x00000203
K[KEY_NUMERIC_4]=0x00000204
K[KEY_NUMERIC_5]=0x00000205
K[KEY_NUMERIC_6]=0x00000206
K[KEY_NUMERIC_7]=0x00000207
K[KEY_NUMERIC_8]=0x00000208
K[KEY_NUMERIC_9]=0x00000209
K[KEY_NUMERIC_STAR]=0x0000020a
K[KEY_NUMERIC_POUND]=0x0000020b
K[KEY_CAMERA_FOCUS]=0x00000210
K[KEY_WPS_BUTTON]=0x00000211
K[KEY_TOUCHPAD_TOGGLE]=0x00000212
K[KEY_TOUCHPAD_ON]=0x00000213
K[KEY_TOUCHPAD_OFF]=0x00000214
K[KEY_CAMERA_ZOOMIN]=0x00000215
K[KEY_CAMERA_ZOOMOUT]=0x00000216
K[KEY_CAMERA_UP]=0x00000217
K[KEY_CAMERA_DOWN]=0x00000218
K[KEY_CAMERA_LEFT]=0x00000219
K[KEY_CAMERA_RIGHT]=0x0000021a
K[KEY_ATTENDANT_ON]=0x0000021b
K[KEY_ATTENDANT_OFF]=0x0000021c
K[KEY_ATTENDANT_TOGGLE]=0x0000021d
K[KEY_LIGHTS_TOGGLE]=0x0000021e
K[KEY_ALS_TOGGLE]=0x00000230
K[KEY_BUTTONCONFIG]=0x00000240
K[KEY_TASKMANAGER]=0x00000241
K[KEY_JOURNAL]=0x00000242
K[KEY_CONTROLPANEL]=0x00000243
K[KEY_APPSELECT]=0x00000244
K[KEY_SCREENSAVER]=0x00000245
K[KEY_VOICECOMMAND]=0x00000246
K[KEY_BRIGHTNESS_MIN]=0x00000250
K[KEY_BRIGHTNESS_MAX]=0x00000251
K[KEY_MAX]=0x000002ff

## buttons, macros, and other definitions extracted from sapphire.h:
##
B[SAPPHIRE_UP]=0x00520000
B[SAPPHIRE_DOWN]=0x00510000
B[SAPPHIRE_RIGHT]=0x004f0000
B[SAPPHIRE_LEFT]=0x00500000
B[SAPPHIRE_ENTEROK]=0x00280000
B[SAPPHIRE_BACK]=0x00040003
B[SAPPHIRE_PLAY]=0x40000003
B[SAPPHIRE_PAUSE]=0x80000003
B[SAPPHIRE_VOLUP]=0x00002003
B[SAPPHIRE_VOLDOWN]=0x00004003
B[SAPPHIRE_CHUP]=0x00010003
B[SAPPHIRE_CHDOWN]=0x00020003
B[SAPPHIRE_MUTE]=0x00001003
B[SAPPHIRE_RECORD]=0x00008003
B[SAPPHIRE_FWD]=0x08000003
B[SAPPHIRE_REW]=0x04000003
B[SAPPHIRE_ANGLE]=0x00010004
B[SAPPHIRE_SAP]=0x00100004
B[SAPPHIRE_DVDMENU]=0x00040004
B[SAPPHIRE_INFOEPG]=0x02000003
B[SAPPHIRE_TAB]=0x00000103
B[SAPPHIRE_BACKTAB]=0x00000203
B[SAPPHIRE_RADIO]=0x00000403
B[SAPPHIRE_LASTCH]=0x00400004
B[SAPPHIRE_LANGUAGE]=0x00020004
B[SAPPHIRE_TELETEXTCC]=0x00200004
B[SAPPHIRE_SUBTITLE]=0x00080004
B[SAPPHIRE_HOMEHOUSE]=0x00000104
B[SAPPHIRE_BLUEVIDEOS]=0x00002004
B[SAPPHIRE_LIVETV]=0x00000204
B[SAPPHIRE_REDDVDVCD]=0x00008004
B[SAPPHIRE_YELLOWPICTURES]=0x00001004
B[SAPPHIRE_1]=0x001e0000
B[SAPPHIRE_2]=0x001f0000
B[SAPPHIRE_3]=0x00200000
B[SAPPHIRE_4]=0x00210000
B[SAPPHIRE_5]=0x00220000
B[SAPPHIRE_6]=0x00230000
B[SAPPHIRE_7]=0x00240000
B[SAPPHIRE_8]=0x00250000
B[SAPPHIRE_9]=0x00260000
B[SAPPHIRE_0]=0x00270000
B[SAPPHIRE_STOP]=0x00100003
B[SAPPHIRE_POWER]=0x00000202
B[SAPPHIRE_CLEAR]=0x004c0000
B[SAPPHIRE_GREENMUSIC]=0x00000804
M[CTRL]=0x80000000
M[SHIFT]=0x40000000
M[ALT]=0x20000000
M[META]=0x10000000
K[KEY_DELAY]=0x00fffff7
B[KEY_MACRO_0]=0x00fffff8
K[KEY_MACRO_0]=0x00fffff8
B[KEY_MACRO_1]=0x00fffff9
K[KEY_MACRO_1]=0x00fffff9
B[KEY_MACRO_2]=0x00fffffa
K[KEY_MACRO_2]=0x00fffffa
B[KEY_MACRO_3]=0x00fffffb
K[KEY_MACRO_3]=0x00fffffb
B[KEY_MACRO_4]=0x00fffffc
K[KEY_MACRO_4]=0x00fffffc
B[KEY_MACRO_5]=0x00fffffd
K[KEY_MACRO_5]=0x00fffffd
B[KEY_MACRO_6]=0x00fffffe
K[KEY_MACRO_6]=0x00fffffe
B[KEY_MACRO_7]=0x00ffffff
K[KEY_MACRO_7]=0x00ffffff
M[NO_REPEAT]=0x00000000
M[SLOW_REPEAT]=0x00000004
M[FAST_REPEAT]=0x00000008
M[RAMP_REPEAT]=0x00000003
M[RAWKEY]=0xffffffff
M[LONGKEY]=0x08000000

PROCFILE=/proc/sapphire
MYNAME="${0##*/}"

function get_multipart_keycode(){
	local parts="$1" val=0 zero_ok=0 p v
	while [ "$parts" != "" ]; do
		p="${parts%%|*}"
		[ "$p" = "$parts" ] && parts="" || parts="${parts#*|}"
		v="${K[$p]}"
		if [ "$v" = "" ]; then
			v="${M[$p]}"
			if [ "$v" = "" ]; then
				logger -s "$MYNAME: ERROR0: $p: unrecognized key/modifier"
				exit 1
			fi 
		fi
		[ $((v)) -eq 0 ] && zero_ok=1 || val=$((val + v))
	done
	[ $val -ne 0 -o $zero_ok -eq 1 ] && printf "0x%08x" $val
}

function parse_keymap(){
	local line blabel bval klabel kval olabel oval out i
	while read line ; do
		line="${line%%#*}"
		set -- $line
		[ "$1" = "" ] && continue
		if [ "$1" = "REPEAT_RATE" -a "$3" != "" ]; then
			out="$1 $2 $3"
		else
			blabel="$1"
			bval="${B[$blabel]}"
			if [ "$bval" = "" ]; then
				logger -s "$MYNAME: ERROR1: $line blabel=$blabel"
				exit 1
			fi
			out=
			if [ "${blabel:0:10}" = "KEY_MACRO_" ]; then
				out="$bval"
				olabel=""
				for i in {2..8} ; do
					klabel="${!i}"
					[ "$klabel" = "" ] && break
					olabel="$olabel $klabel"
					kval=$(get_multipart_keycode "$klabel")
					if [ "$kval" = "" ]; then
						logger -s "$MYNAME: ERROR2: $line"
						exit 1
					fi
					out="$out $kval"
				done
				klabel=""
			else
				klabel="$2"
				olabel="$3"
				if [ "$blabel" = "" -o "$klabel" = "" -o "$olabel" = "" ]; then
					logger -s "$MYNAME: ERROR3: $line"
					exit 1
				fi
				kval=$(get_multipart_keycode "$klabel")
				oval=$(get_multipart_keycode "$olabel")
				if [ "$bval" = "" -o "$kval" = "" -o "$oval" = "" ]; then
					logger -s "$MYNAME: ERROR4: $blabel=$bval $klabel=$kval $olabel=$oval"
					exit 1
				fi
				out="$bval $kval $oval"
			fi
		fi
		[ $VERBOSE -gt 0 ] && echo "echo \"$out\" >$PROCFILE  # $blabel $klabel $olabel" >&2
		echo "$out" >$PROCFILE || exit 2
		out=
	done
}

if [ ! -e $PROCFILE ]; then
	echo "$PROCFILE: not found (is driver loaded?)"
	exit 1
fi

VERBOSE=0
while [ "$1" = "-v" -o "$1" = "--verbose" ]; do
	VERBOSE=$((VERBOSE + 1))
	shift
done

KEYMAP="$1"
[ "$KEYMAP" = "" ] && KEYMAP=/etc/sapphire.keymap
if [ ! -e "$KEYMAP" ]; then
	logger -s "$MYNAME: $KEYMAP: not readable"
	exit 1
fi

type -all logger &>/dev/null && logcmd="logger -s --" || logcmd=echo
$logcmd "${0##*/}: sending \"$KEYMAP\" to $PROCFILE"
cat "$KEYMAP" | parse_keymap

