define(["appSettings","browser","events"],function(appSettings,browser,events){"use strict";var recoverDecodingErrorDate,recoverSwapAudioCodecDate;function handleHlsJsMediaError(instance,reject){var hlsPlayer=instance._hlsPlayer;if(hlsPlayer){var now=Date.now();window.performance&&window.performance.now&&(now=performance.now()),!recoverDecodingErrorDate||3e3<now-recoverDecodingErrorDate?(recoverDecodingErrorDate=now,console.log("try to recover media Error ..."),hlsPlayer.recoverMediaError()):!recoverSwapAudioCodecDate||3e3<now-recoverSwapAudioCodecDate?(recoverSwapAudioCodecDate=now,console.log("try to swap Audio Codec and recover media Error ..."),hlsPlayer.swapAudioCodec(),hlsPlayer.recoverMediaError()):(console.error("cannot recover, last media error recovery failed ..."),reject?reject():onErrorInternal(instance,"mediadecodeerror"))}}function onErrorInternal(instance,type){instance.destroyCustomTrack&&instance.destroyCustomTrack(instance._mediaElement),events.trigger(instance,"error",[{type:type}])}function isValidDuration(duration){return!(!duration||isNaN(duration)||duration===Number.POSITIVE_INFINITY||duration===Number.NEGATIVE_INFINITY)}function onSuccessfulPlay(elem,onErrorFn){elem.addEventListener("error",onErrorFn)}function playWithPromise(elem,onErrorFn){try{var promise=elem.play();return promise&&promise.then?promise.then(function(e){return Promise.resolve({autoplayed:!0})}.bind(elem),function(e){var errorName=(e.name||"").toLowerCase();return"notallowederror"===errorName||"aborterror"===errorName?(onSuccessfulPlay(elem,onErrorFn),Promise.resolve({autoplayed:!1})):Promise.reject()}):(onSuccessfulPlay(elem,onErrorFn),Promise.resolve({autoplayed:browser.tv||browser.ps4||browser.chromecast}))}catch(err){return console.log("error calling video.play: "+err),Promise.reject()}}function destroyCastPlayer(instance){var player=instance._castPlayer;if(player){try{player.unload()}catch(err){console.log(err)}instance._castPlayer=null}}function destroyHlsPlayer(instance){var player=instance._hlsPlayer;if(player){try{player.destroy()}catch(err){console.log(err)}instance._hlsPlayer=null}}function destroyFlvPlayer(instance){var player=instance._flvPlayer;if(player){try{player.unload(),player.detachMediaElement(),player.destroy()}catch(err){console.log(err)}instance._flvPlayer=null}}function getDeviceProfileInternal(appHost,item,options){return appHost.getDeviceProfile?appHost.getDeviceProfile(item,options):require(["browserdeviceprofile"]).then(function(responses){return responses[0]({})})}return{getSavedVolume:function(){return appSettings.get("volume")||1},saveVolume:function(value){value&&appSettings.set("volume",value)},enableHlsJsPlayer:function(runTimeTicks,mediaType,hasHlsTextTracks){if(null==window.MediaSource)return!1;if(browser.tizen||browser.web0s||browser.netcast||browser.orsay)return!1;if(function(){var media=document.createElement("video");return!(!media.canPlayType("application/x-mpegURL").replace(/no/,"")&&!media.canPlayType("application/vnd.apple.mpegURL").replace(/no/,""))}()){if(browser.edge)return!1;if(browser.android&&"Audio"===mediaType)return!0;if(runTimeTicks){if("Audio"===mediaType)return!1;if(browser.chromecast||browser.ps4)return!1}if(browser.safari)return!1}return!0},enableHlsShakaPlayer:function(runTimeTicks,mediaType){return null==window.MediaSource||browser.tizen||browser.web0s||browser.netcast||browser.orsay||browser.edge,!1},handleHlsJsMediaError:handleHlsJsMediaError,isValidDuration:isValidDuration,onErrorInternal:onErrorInternal,applySrc:function(elem,src,options){return window.Windows&&options.mediaSource&&options.mediaSource.IsLocal?Windows.Storage.StorageFile.getFileFromPathAsync(options.url).then(function(file){return elem.src=URL.createObjectURL(file,{oneTimeOnly:!0}),Promise.resolve()}):(elem.src=src,Promise.resolve())},playWithPromise:playWithPromise,destroyHlsPlayer:destroyHlsPlayer,destroyFlvPlayer:destroyFlvPlayer,destroyCastPlayer:destroyCastPlayer,bindEventsToHlsPlayer:function(instance,hls,elem,onErrorFn,resolve,reject){hls.on(Hls.Events.MANIFEST_PARSED,function(){playWithPromise(elem,onErrorFn).then(resolve,function(){reject&&(reject(),reject=null)})}),hls.on(Hls.Events.ERROR,function(event,data){switch(console.log("HLS Error: Type: "+data.type+" Details: "+(data.details||"")+" Fatal: "+(data.fatal||!1)),data.type){case Hls.ErrorTypes.NETWORK_ERROR:if(data.response&&data.response.code&&400<=data.response.code)return console.log("hls.js response error code: "+data.response.code),hls.destroy(),void(reject?(reject("servererror"),reject=null):onErrorInternal(instance,"servererror"))}if(data.fatal)switch(data.type){case Hls.ErrorTypes.NETWORK_ERROR:data.response&&0===data.response.code?(console.log("hls.js response error code: "+data.response.code),hls.destroy(),reject?(reject("network"),reject=null):onErrorInternal(instance,"network")):(console.log("fatal network error encountered, try to recover"),hls.startLoad());break;case Hls.ErrorTypes.MEDIA_ERROR:console.log("fatal media error encountered, try to recover");var currentReject=reject;reject=null,handleHlsJsMediaError(instance,currentReject);break;default:console.log("Cannot recover from hls error - destroy and trigger error"),hls.destroy(),reject?(reject(),reject=null):onErrorInternal(instance,"mediadecodeerror")}})},onEndedInternal:function(instance,elem,onErrorFn){elem.removeEventListener("error",onErrorFn),elem.src="",elem.innerHTML="",elem.removeAttribute("src"),destroyHlsPlayer(instance),destroyFlvPlayer(instance),function(instance){var player=instance._shakaPlayer;if(player){try{player.destroy()}catch(err){console.log(err)}instance._shakaPlayer=null}}(instance),destroyCastPlayer(instance);var stopInfo={src:instance._currentSrc};events.trigger(instance,"stopped",[stopInfo]),instance._currentTime=null,instance._currentSrc=null,instance._currentPlayOptions=null},getCrossOriginValue:function(mediaSource,playMethod){return mediaSource.IsRemote&&"DirectPlay"===playMethod?null:"anonymous"},getBufferedRanges:function(instance,elem){var offset,ranges=[],seekable=elem.buffered||[],currentPlayOptions=instance._currentPlayOptions;currentPlayOptions&&(offset=currentPlayOptions.transcodingOffsetTicks),offset=offset||0;for(var i=0,length=seekable.length;i<length;i++){var start=seekable.start(i),end=seekable.end(i);isValidDuration(start)||(start=0),isValidDuration(end)?ranges.push({start:1e7*start+offset,end:1e7*end+offset}):end=0}return ranges},getDeviceProfile:function(instance,appHost,item,options){return getDeviceProfileInternal(appHost,item,options).then(function(profile){return instance._lastProfile=profile})}}});