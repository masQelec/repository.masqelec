var SubtitlesOctopus=function(options){var ctx,self=this;function renderFrame(){self.ctx.putImageData(new ImageData(self.renderFrameData,self.canvas.width,self.canvas.height),0,0),self.renderFrameData=null}function renderFrames(){var data=self.renderFramesData,beforeDrawTime=performance.now();self.ctx.clearRect(0,0,self.canvas.width,self.canvas.height);for(var i=0;i<data.canvases.length;i++){var image=data.canvases[i];self.bufferCanvas.width=image.w,self.bufferCanvas.height=image.h;var imageBuffer=new Uint8ClampedArray(image.buffer),imageData=new ImageData(imageBuffer,image.w,image.h);self.bufferCanvasCtx.putImageData(imageData,0,0),self.ctx.drawImage(self.bufferCanvas,image.x,image.y)}if(self.debug){var drawTime=Math.round(performance.now()-beforeDrawTime);console.log(Math.round(data.spentTime)+" ms (+ "+drawTime+" ms draw)"),self.renderStart=performance.now()}}self.canvas=options.canvas,self.isOurCanvas=!1,self.video=options.video,self.canvasParent=null,self.fonts=options.fonts||[],self.availableFonts=options.availableFonts||[],self.onReadyEvent=options.onReady,self.workerUrl=options.workerUrl||"libassjs-worker.js",self.subUrl=options.subUrl,self.subContent=options.subContent||null,self.onErrorEvent=options.onError,self.debug=options.debug||!1,self.lastRenderTime=0,self.pixelRatio=window.devicePixelRatio||1,self.timeOffset=options.timeOffset||0,"function"!=typeof ImageData.prototype.constructor&&(ctx=document.createElement("canvas").getContext("2d"),window.ImageData=function(){var i=0;if(arguments[0]instanceof Uint8ClampedArray)var data=arguments[i++];var width=arguments[i++],height=arguments[i],imageData=ctx.createImageData(width,height);return data&&imageData.data.set(data),imageData}),self.workerError=function(error){if(console.error("Worker error: ",error),self.onErrorEvent&&self.onErrorEvent(error),!self.debug)throw self.dispose(),new Error("Worker error: "+error)},self.init=function(){window.Worker?(self.worker||(self.worker=new Worker(self.workerUrl),self.worker.onmessage=self.onWorkerMessage,self.worker.onerror=self.workerError),self.workerActive=!1,self.createCanvas(),self.setVideo(options.video),self.setSubUrl(options.subUrl),self.worker.postMessage({target:"worker-init",width:self.canvas.width,height:self.canvas.height,URL:document.URL,currentScript:self.workerUrl,preMain:!0,subUrl:self.subUrl,subContent:self.subContent,fonts:self.fonts,availableFonts:self.availableFonts})):self.workerError("worker not supported")},self.createCanvas=function(){self.canvas||(self.video?(self.isOurCanvas=!0,self.canvas=document.createElement("canvas"),self.canvas.className="libassjs-canvas",self.canvas.style.display="none",self.canvasParent=document.createElement("div"),self.canvasParent.className="libassjs-canvas-parent",self.canvasParent.appendChild(self.canvas),self.video.nextSibling?self.video.parentNode.insertBefore(self.canvasParent,self.video.nextSibling):self.video.parentNode.appendChild(self.canvasParent)):self.canvas||self.workerError("Don't know where to render: you should give video or canvas in options.")),self.ctx=self.canvas.getContext("2d"),self.bufferCanvas=document.createElement("canvas"),self.bufferCanvasCtx=self.bufferCanvas.getContext("2d")},self.setVideo=function(video){if(self.video=video,self.video){function timeupdate(){self.setCurrentTime(video.currentTime+self.timeOffset)}self.video.addEventListener("timeupdate",timeupdate,!1),self.video.addEventListener("playing",function(){self.setIsPaused(!1,video.currentTime+self.timeOffset)},!1),self.video.addEventListener("pause",function(){self.setIsPaused(!0,video.currentTime+self.timeOffset)},!1),self.video.addEventListener("seeking",function(){self.video.removeEventListener("timeupdate",timeupdate)},!1),self.video.addEventListener("seeked",function(){self.video.addEventListener("timeupdate",timeupdate,!1),self.setCurrentTime(video.currentTime+self.timeOffset)},!1),self.video.addEventListener("ratechange",function(){self.setRate(video.playbackRate)},!1),self.video.addEventListener("timeupdate",function(){self.setCurrentTime(video.currentTime+self.timeOffset)},!1),self.video.addEventListener("waiting",function(){self.setIsPaused(!0,video.currentTime+self.timeOffset)},!1),document.addEventListener("fullscreenchange",self.resizeWithTimeout,!1),document.addEventListener("mozfullscreenchange",self.resizeWithTimeout,!1),document.addEventListener("webkitfullscreenchange",self.resizeWithTimeout,!1),document.addEventListener("msfullscreenchange",self.resizeWithTimeout,!1),window.addEventListener("resize",self.resizeWithTimeout,!1),"undefined"!=typeof ResizeObserver&&(self.ro=new ResizeObserver(self.resizeWithTimeout),self.ro.observe(self.video)),0<self.video.videoWidth?self.resize():self.video.addEventListener("loadedmetadata",function(e){e.target.removeEventListener(e.type,arguments.callee),self.resize()},!1)}},self.getVideoPosition=function(){var videoRatio=self.video.videoWidth/self.video.videoHeight,width=self.video.offsetWidth,height=self.video.offsetHeight,realWidth=width,realHeight=height;return videoRatio<width/height?realWidth=Math.floor(height*videoRatio):realHeight=Math.floor(width/videoRatio),{width:realWidth,height:realHeight,x:(width-realWidth)/2,y:(height-realHeight)/2}},self.setSubUrl=function(subUrl){self.subUrl=subUrl},self.cloneObject=function(event){var ret={};for(var x in event)if(x!=x.toUpperCase()){var prop=event[x];"number"!=typeof prop&&"string"!=typeof prop||(ret[x]=prop)}return ret},self.renderFrameData=null,self.workerActive=!1,self.frameId=0,self.onWorkerMessage=function(event){self.workerActive||(self.workerActive=!0,self.onReadyEvent&&self.onReadyEvent());var data=event.data;switch(data.target){case"stdout":console.log(data.content);break;case"stderr":console.error(data.content);break;case"window":window[data.method]();break;case"canvas":switch(data.op){case"getContext":self.ctx=self.canvas.getContext(data.type,data.attributes);break;case"resize":self.resize(data.width,data.height);break;case"render":self.renderFrameData||window.requestAnimationFrame(renderFrame),data.buffer?self.renderFrameData=new Uint8ClampedArray(data.buffer):self.renderFrameData=data.image.data;break;case"renderMultiple":self.lastRenderTime<data.time&&(self.lastRenderTime=data.time,self.renderFramesData=data,window.requestAnimationFrame(renderFrames));break;case"setObjectProperty":self.canvas[data.object][data.property]=data.value;break;default:throw"eh?"}break;case"tick":self.frameId=data.id,self.worker.postMessage({target:"tock",id:self.frameId});break;case"Image":assert("src"===data.method);var img=new Image;img.onload=function(){assert(img.complete);var canvas=document.createElement("canvas");canvas.width=img.width,canvas.height=img.height;var ctx=canvas.getContext("2d");ctx.drawImage(img,0,0);var imageData=ctx.getImageData(0,0,img.width,img.height);self.worker.postMessage({target:"Image",method:"onload",id:data.id,width:img.width,height:img.height,data:imageData.data,preMain:!0})},img.onerror=function(){self.worker.postMessage({target:"Image",method:"onerror",id:data.id,preMain:!0})},img.src=data.src;break;case"custom":if(!self.onCustomMessage)throw"Custom message received but client onCustomMessage not implemented.";self.onCustomMessage(event);break;case"setimmediate":self.worker.postMessage({target:"setimmediate"});break;default:throw"what? "+data.target}},self.resize=function(width,height,top,left){var videoSize=null;if(top=top||0,left=left||0,(!width||!height)&&self.video){width=(videoSize=self.getVideoPosition()).width*self.pixelRatio,height=videoSize.height*self.pixelRatio;var offset=self.canvasParent.getBoundingClientRect().top-self.video.getBoundingClientRect().top;top=videoSize.y-offset,left=videoSize.x}width&&height?self.canvas.width==width&&self.canvas.height==height&&self.canvas.style.top==top&&self.canvas.style.left==left||(self.canvas.width=width,self.canvas.height=height,null!=videoSize&&(self.canvasParent.style.position="relative",self.canvas.style.display="block",self.canvas.style.position="absolute",self.canvas.style.width=videoSize.width+"px",self.canvas.style.height=videoSize.height+"px",self.canvas.style.top=top+"px",self.canvas.style.left=left+"px",self.canvas.style.pointerEvents="none"),self.worker.postMessage({target:"canvas",width:self.canvas.width,height:self.canvas.height})):self.video||console.error("width or height is 0. You should specify width & height for resize.")},self.resizeWithTimeout=function(){self.resize(),setTimeout(self.resize,100)},self.runBenchmark=function(){self.worker.postMessage({target:"runBenchmark"})},self.customMessage=function(data,options){options=options||{},self.worker.postMessage({target:"custom",userData:data,preMain:options.preMain})},self.setCurrentTime=function(currentTime){self.worker.postMessage({target:"video",currentTime:currentTime})},self.setTrackByUrl=function(url){self.worker.postMessage({target:"set-track-by-url",url:url})},self.setTrack=function(content){self.worker.postMessage({target:"set-track",content:content})},self.freeTrack=function(content){self.worker.postMessage({target:"free-track"})},self.render=self.setCurrentTime,self.setIsPaused=function(isPaused,currentTime){self.worker.postMessage({target:"video",isPaused:isPaused,currentTime:currentTime})},self.setRate=function(rate){self.worker.postMessage({target:"video",rate:rate})},self.dispose=function(){self.worker.postMessage({target:"destroy"}),self.worker.terminate(),self.workerActive=!1,self.video&&self.video.parentNode.removeChild(self.canvasParent)},self.init()};"function"==typeof SubtitlesOctopusOnLoad&&SubtitlesOctopusOnLoad(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=SubtitlesOctopus);